<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI App Design Helper</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>✨</text></svg>">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a0b;
      --bg-secondary: #141416;
      --bg-elevated: #1c1c1f;
      --bg-hover: #252528;
      --border: #2a2a2e;
      --border-light: #3a3a3f;
      --text-primary: #f5f5f7;
      --text-secondary: #a1a1a6;
      --text-muted: #6e6e73;
      --accent: #6366f1;
      --accent-hover: #818cf8;
      --accent-muted: rgba(99, 102, 241, 0.15);
      --success: #22c55e;
      --success-muted: rgba(34, 197, 94, 0.15);
      --warning: #f59e0b;
      --warning-muted: rgba(245, 158, 11, 0.15);
      --error: #ef4444;
      --gradient-1: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #d946ef 100%);
      --gradient-2: linear-gradient(135deg, #0a0a0b 0%, #1a1a2e 100%);
      --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --radius-xl: 24px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    #root { min-height: 100vh; }

    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-secondary); }
    ::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    .animate-slide-in { animation: slideIn 0.4s ease-out forwards; }
    .stagger-1 { animation-delay: 0.1s; opacity: 0; }
    .stagger-2 { animation-delay: 0.2s; opacity: 0; }
    .stagger-3 { animation-delay: 0.3s; opacity: 0; }
    .stagger-4 { animation-delay: 0.4s; opacity: 0; }
    .stagger-5 { animation-delay: 0.5s; opacity: 0; }
    .stagger-6 { animation-delay: 0.6s; opacity: 0; }

    /* Card hover effects */
    .hover-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .hover-card:hover {
      border-color: var(--border-light);
      transform: translateY(-3px);
      box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.4);
    }

    /* Agent card colored glow on hover */
    .hover-card-glow {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .hover-card-glow:hover {
      transform: translateY(-3px);
      box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.4);
    }

    /* Toast notification */
    @keyframes toastIn {
      from { opacity: 0; transform: translateY(20px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes toastOut {
      from { opacity: 1; transform: translateY(0) scale(1); }
      to { opacity: 0; transform: translateY(20px) scale(0.95); }
    }
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .toast {
      padding: 14px 20px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: toastIn 0.3s ease-out forwards;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      max-width: 360px;
    }
    .toast.closing {
      animation: toastOut 0.3s ease-in forwards;
    }
    .toast-success {
      background: #0d3320;
      border: 1px solid var(--success);
      color: var(--success);
    }
    .toast-error {
      background: #3d1111;
      border: 1px solid var(--error);
      color: var(--error);
    }
    .toast-info {
      background: #1a1a3e;
      border: 1px solid var(--accent);
      color: var(--accent);
    }

    /* AI Output formatting */
    .ai-output h1, .ai-output h2, .ai-output h3, .ai-output h4 {
      font-weight: 600;
      margin: 20px 0 8px 0;
      color: var(--text-primary);
    }
    .ai-output h1 { font-size: 20px; }
    .ai-output h2 { font-size: 18px; }
    .ai-output h3 { font-size: 16px; }
    .ai-output p { margin: 8px 0; line-height: 1.7; }
    .ai-output ul, .ai-output ol {
      margin: 8px 0;
      padding-left: 24px;
    }
    .ai-output li {
      margin: 4px 0;
      line-height: 1.6;
    }
    .ai-output code {
      background: var(--bg-elevated);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 13px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      color: var(--accent-hover);
    }
    .ai-output pre {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin: 12px 0;
      overflow-x: auto;
      font-size: 13px;
      line-height: 1.5;
      font-family: 'SF Mono', 'Fira Code', monospace;
    }
    .ai-output pre code {
      background: none;
      padding: 0;
      color: var(--text-primary);
    }
    .ai-output strong, .ai-output b {
      color: var(--text-primary);
      font-weight: 600;
    }
    .ai-output hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 16px 0;
    }

    /* Typing / skeleton loader */
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    .skeleton-line {
      height: 14px;
      border-radius: 6px;
      background: linear-gradient(90deg, var(--bg-elevated) 25%, var(--border) 50%, var(--bg-elevated) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s ease-in-out infinite;
      margin: 12px 0;
    }

    /* Copy button */
    .copy-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 6px 12px;
      border-radius: 6px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      color: var(--text-muted);
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      font-family: inherit;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .copy-btn:hover {
      border-color: var(--border-light);
      color: var(--text-primary);
      background: var(--bg-hover);
    }

  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    // ============================================
    // SUPABASE CONFIG
    // ============================================
    const supabase = window.supabase.createClient(
      'https://wrdgqkubpfzwitymmwsa.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndyZGdxa3VicGZ6d2l0eW1td3NhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NzMzMTQsImV4cCI6MjA4NTU0OTMxNH0.971l5ywBnpP_JdDwKHuoD2crQVkXUSWBUt1Z4QnChRc'
    );

    // ============================================
    // ICONS
    // ============================================
    const Icons = {
      Lightbulb: () => (
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/>
          <path d="M9 18h6"/><path d="M10 22h4"/>
        </svg>
      ),
      List: () => (
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/>
          <line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/>
        </svg>
      ),
      Layout: () => (
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
          <line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/>
        </svg>
      ),
      Cpu: () => (
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <rect x="4" y="4" width="16" height="16" rx="2" ry="2"/><rect x="9" y="9" width="6" height="6"/>
          <line x1="9" y1="1" x2="9" y2="4"/><line x1="15" y1="1" x2="15" y2="4"/>
          <line x1="9" y1="20" x2="9" y2="23"/><line x1="15" y1="20" x2="15" y2="23"/>
          <line x1="20" y1="9" x2="23" y2="9"/><line x1="20" y1="14" x2="23" y2="14"/>
          <line x1="1" y1="9" x2="4" y2="9"/><line x1="1" y1="14" x2="4" y2="14"/>
        </svg>
      ),
      Code: () => (
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <polyline points="16,18 22,12 16,6"/><polyline points="8,6 2,12 8,18"/>
        </svg>
      ),
      Calendar: () => (
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/>
          <line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
        </svg>
      ),
      Settings: () => (
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
        </svg>
      ),
      Plus: () => (
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
      ),
      ArrowRight: () => (
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <line x1="5" y1="12" x2="19" y2="12"/><polyline points="12,5 19,12 12,19"/>
        </svg>
      ),
      Check: () => (
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <polyline points="20,6 9,17 4,12"/>
        </svg>
      ),
      User: () => (
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
        </svg>
      ),
      LogOut: () => (
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" y1="12" x2="9" y2="12"/>
        </svg>
      ),
      Folder: () => (
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
        </svg>
      ),
      Sparkles: () => (
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M12 3l1.912 5.813a2 2 0 0 0 1.275 1.275L21 12l-5.813 1.912a2 2 0 0 0-1.275 1.275L12 21l-1.912-5.813a2 2 0 0 0-1.275-1.275L3 12l5.813-1.912a2 2 0 0 0 1.275-1.275L12 3z"/>
        </svg>
      ),
      ChevronLeft: () => (
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <polyline points="15,18 9,12 15,6"/>
        </svg>
      ),
      ChevronRight: () => (
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <polyline points="9,6 15,12 9,18"/>
        </svg>
      ),
      Loader: () => (
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{animation: 'spin 1s linear infinite'}}>
          <line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/>
          <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/>
          <line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/>
          <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/>
        </svg>
      ),
      Workflow: () => (
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <rect x="3" y="3" width="6" height="6" rx="1"/><rect x="15" y="3" width="6" height="6" rx="1"/>
          <rect x="9" y="15" width="6" height="6" rx="1"/><path d="M6 9v3a1 1 0 0 0 1 1h4"/>
          <path d="M18 9v3a1 1 0 0 1-1 1h-4"/>
        </svg>
      ),
      Trash: () => (
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <polyline points="3,6 5,6 21,6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
        </svg>
      ),
      Mail: () => (
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/>
        </svg>
      ),
    };

    // ============================================
    // TOAST SYSTEM
    // ============================================
    const ToastContext = React.createContext(null);

    const ToastProvider = ({ children }) => {
      const [toasts, setToasts] = useState([]);
      const addToast = useCallback((message, type = 'success') => {
        const id = Date.now();
        setToasts(prev => [...prev, { id, message, type, closing: false }]);
        setTimeout(() => {
          setToasts(prev => prev.map(t => t.id === id ? { ...t, closing: true } : t));
          setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 300);
        }, 3000);
      }, []);
      return (
        <ToastContext.Provider value={addToast}>
          {children}
          <div className="toast-container">
            {toasts.map(t => (
              <div key={t.id} className={`toast toast-${t.type}${t.closing ? ' closing' : ''}`}>
                {t.type === 'success' && <Icons.Check />}
                {t.type === 'error' && '⚠'}
                {t.type === 'info' && <Icons.Sparkles />}
                {t.message}
              </div>
            ))}
          </div>
        </ToastContext.Provider>
      );
    };

    const useToast = () => React.useContext(ToastContext);

    // ============================================
    // MARKDOWN RENDERER
    // ============================================
    const MarkdownOutput = ({ text }) => {
      const renderMarkdown = (md) => {
        if (!md) return '';
        let html = md;
        // Code blocks (``` ... ```)
        html = html.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
        // Inline code
        html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
        // Headers
        html = html.replace(/^#### (.+)$/gm, '<h4>$1</h4>');
        html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
        html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
        html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
        // Bold
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        // Italic
        html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
        // Horizontal rule
        html = html.replace(/^---$/gm, '<hr>');
        // Unordered lists
        html = html.replace(/^[•\-\*] (.+)$/gm, '<li>$1</li>');
        // Ordered lists
        html = html.replace(/^\d+\.\s(.+)$/gm, '<li>$1</li>');
        // Wrap consecutive <li> in <ul>
        html = html.replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');
        // Paragraphs (lines that aren't already wrapped)
        html = html.replace(/^(?!<[huolp]|<li|<pre|<hr)(.+)$/gm, '<p>$1</p>');
        return html;
      };

      return (
        <div
          className="ai-output"
          style={{ fontSize: '14px', lineHeight: 1.7, color: 'var(--text-primary)', maxHeight: '500px', overflow: 'auto' }}
          dangerouslySetInnerHTML={{ __html: renderMarkdown(text) }}
        />
      );
    };

    // ============================================
    // COPY BUTTON
    // ============================================
    const CopyButton = ({ text, inline }) => {
      const [copied, setCopied] = useState(false);
      const handleCopy = async () => {
        try {
          await navigator.clipboard.writeText(text);
          setCopied(true);
          setTimeout(() => setCopied(false), 2000);
        } catch (err) {
          const ta = document.createElement('textarea');
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          setCopied(true);
          setTimeout(() => setCopied(false), 2000);
        }
      };
      return (
        <button className="copy-btn" style={inline ? { position: 'relative', top: 'auto', right: 'auto' } : {}} onClick={handleCopy}>
          {copied ? <><Icons.Check /> Copied!</> : 'Copy'}
        </button>
      );
    };

    // ============================================
    // LOADING SKELETON
    // ============================================
    const LoadingSkeleton = () => (
      <div style={{ padding: '8px 0' }}>
        <div className="skeleton-line" style={{ width: '60%' }} />
        <div className="skeleton-line" style={{ width: '90%' }} />
        <div className="skeleton-line" style={{ width: '75%' }} />
        <div className="skeleton-line" style={{ width: '85%' }} />
        <div style={{ height: '24px' }} />
        <div className="skeleton-line" style={{ width: '50%' }} />
        <div className="skeleton-line" style={{ width: '95%' }} />
        <div className="skeleton-line" style={{ width: '80%' }} />
        <div className="skeleton-line" style={{ width: '70%' }} />
      </div>
    );

    // ============================================
    // STYLES
    // ============================================
    const styles = {
      container: { minHeight: '100vh', display: 'flex', flexDirection: 'column' },
      main: { flex: 1, display: 'flex' },
      sidebar: { width: '280px', background: 'var(--bg-secondary)', borderRight: '1px solid var(--border)', display: 'flex', flexDirection: 'column', position: 'fixed', left: 0, top: 0, bottom: 0, zIndex: 100 },
      content: { flex: 1, marginLeft: '280px', padding: '32px 48px', minHeight: '100vh' },
      logo: { padding: '24px', borderBottom: '1px solid var(--border)' },
      logoText: { fontFamily: "'Instrument Serif', Georgia, serif", fontSize: '24px', fontWeight: 400, fontStyle: 'italic', background: 'var(--gradient-1)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent', letterSpacing: '-0.02em' },
      nav: { flex: 1, padding: '16px', overflowY: 'auto' },
      navSection: { marginBottom: '24px' },
      navLabel: { fontSize: '11px', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.08em', color: 'var(--text-muted)', padding: '8px 12px' },
      navItem: { display: 'flex', alignItems: 'center', gap: '12px', padding: '12px', borderRadius: 'var(--radius-md)', cursor: 'pointer', transition: 'all 0.2s ease', color: 'var(--text-secondary)', border: 'none', background: 'transparent', width: '100%', textAlign: 'left', fontSize: '14px', fontWeight: 500 },
      navItemActive: { background: 'var(--accent-muted)', color: 'var(--accent)' },
      navItemHover: { background: 'var(--bg-hover)', color: 'var(--text-primary)' },
      card: { background: 'var(--bg-secondary)', borderRadius: 'var(--radius-lg)', border: '1px solid var(--border)', padding: '24px', transition: 'all 0.3s ease' },
      cardHover: { borderColor: 'var(--border-light)', transform: 'translateY(-2px)', boxShadow: 'var(--shadow-lg)' },
      button: { display: 'inline-flex', alignItems: 'center', justifyContent: 'center', gap: '8px', padding: '12px 24px', borderRadius: 'var(--radius-md)', fontSize: '14px', fontWeight: 600, cursor: 'pointer', transition: 'all 0.2s ease', border: 'none', fontFamily: 'inherit' },
      buttonPrimary: { background: 'var(--accent)', color: 'white' },
      buttonSecondary: { background: 'var(--bg-elevated)', color: 'var(--text-primary)', border: '1px solid var(--border)' },
      buttonGhost: { background: 'transparent', color: 'var(--text-secondary)' },
      buttonSuccess: { background: 'var(--success)', color: 'white' },
      input: { width: '100%', padding: '14px 16px', borderRadius: 'var(--radius-md)', border: '1px solid var(--border)', background: 'var(--bg-elevated)', color: 'var(--text-primary)', fontSize: '14px', fontFamily: 'inherit', transition: 'all 0.2s ease', outline: 'none' },
      inputFocus: { borderColor: 'var(--accent)', boxShadow: '0 0 0 3px var(--accent-muted)' },
      textarea: { resize: 'vertical', minHeight: '120px' },
      label: { display: 'block', fontSize: '13px', fontWeight: 500, color: 'var(--text-secondary)', marginBottom: '8px' },
      h1: { fontFamily: "'Instrument Serif', Georgia, serif", fontSize: '48px', fontWeight: 400, letterSpacing: '-0.02em', lineHeight: 1.1, marginBottom: '16px' },
      h2: { fontSize: '24px', fontWeight: 600, letterSpacing: '-0.01em', marginBottom: '8px' },
      h3: { fontSize: '18px', fontWeight: 600, marginBottom: '4px' },
      badge: { display: 'inline-flex', alignItems: 'center', padding: '4px 10px', borderRadius: '100px', fontSize: '12px', fontWeight: 500 },
      badgeSuccess: { background: 'rgba(34, 197, 94, 0.15)', color: 'var(--success)' },
      badgeWarning: { background: 'rgba(245, 158, 11, 0.15)', color: 'var(--warning)' },
      badgeMuted: { background: 'var(--bg-elevated)', color: 'var(--text-muted)' },
      grid: { display: 'grid', gap: '24px' },
      authContainer: { minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '24px', background: 'var(--gradient-2)' },
      authCard: { width: '100%', maxWidth: '420px', background: 'var(--bg-secondary)', borderRadius: 'var(--radius-xl)', border: '1px solid var(--border)', padding: '48px', boxShadow: 'var(--shadow-lg)' },
      agentIcon: { width: '48px', height: '48px', borderRadius: 'var(--radius-md)', display: 'flex', alignItems: 'center', justifyContent: 'center', marginBottom: '16px' },
    };

    // ============================================
    // TIME FORMATTING
    // ============================================
    const timeAgo = (dateStr) => {
      if (!dateStr) return '';
      const now = new Date();
      const date = new Date(dateStr);
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHrs = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHrs < 24) return `${diffHrs}h ago`;
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 30) return `${diffDays}d ago`;
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    };

    const formatDate = (dateStr) => {
      if (!dateStr) return '';
      return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    };

    // ============================================
    // PROJECTION SCORECARD
    // ============================================
    const ScoreBar = ({ label, score, color }) => (
      <div style={{ marginBottom: '16px' }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '6px' }}>
          <span style={{ fontSize: '14px', fontWeight: 500, color: 'var(--text-primary)' }}>{label}</span>
          <span style={{ fontSize: '14px', fontWeight: 600, color }}>{score}/100</span>
        </div>
        <div style={{ height: '8px', background: 'var(--bg-elevated)', borderRadius: '4px', overflow: 'hidden' }}>
          <div style={{ width: `${score}%`, height: '100%', background: color, borderRadius: '4px', transition: 'width 1s ease-out' }} />
        </div>
      </div>
    );

    const ProjectionCard = ({ projection }) => {
      if (!projection) return null;
      const overall = projection.overall || 0;
      const getOverallColor = (s) => s >= 75 ? 'var(--success)' : s >= 50 ? 'var(--warning)' : 'var(--error)';
      const getOverallLabel = (s) => s >= 85 ? 'Exceptional' : s >= 75 ? 'Very Promising' : s >= 60 ? 'Promising' : s >= 45 ? 'Moderate Potential' : 'Needs Work';
      const barColor = (s) => s >= 70 ? '#22c55e' : s >= 50 ? '#f59e0b' : '#ef4444';
      return (
        <div style={{ ...styles.card, border: `1px solid ${getOverallColor(overall)}`, overflow: 'hidden' }} className="animate-fade-in">
          <div style={{ display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '24px' }}>
            <div style={{ width: '72px', height: '72px', borderRadius: '50%', background: `${getOverallColor(overall)}20`, border: `3px solid ${getOverallColor(overall)}`, display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0 }}>
              <span style={{ fontSize: '24px', fontWeight: 700, color: getOverallColor(overall) }}>{overall}</span>
            </div>
            <div>
              <h3 style={{ fontSize: '18px', fontWeight: 600, marginBottom: '4px' }}>Project Projection</h3>
              <span style={{ fontSize: '14px', fontWeight: 600, color: getOverallColor(overall) }}>{getOverallLabel(overall)}</span>
            </div>
          </div>
          <ScoreBar label="Viability" score={projection.viability || 0} color={barColor(projection.viability || 0)} />
          <ScoreBar label="Usefulness" score={projection.usefulness || 0} color={barColor(projection.usefulness || 0)} />
          <ScoreBar label="Market Potential" score={projection.market || 0} color={barColor(projection.market || 0)} />
          <ScoreBar label="Innovation" score={projection.innovation || 0} color={barColor(projection.innovation || 0)} />
          {projection.summary && (
            <div style={{ marginTop: '20px', padding: '16px', background: 'var(--bg-elevated)', borderRadius: 'var(--radius-md)', fontSize: '14px', color: 'var(--text-secondary)', lineHeight: 1.7 }}>
              {projection.summary}
            </div>
          )}
          {projection.strengths && projection.strengths.length > 0 && (
            <div style={{ marginTop: '16px' }}>
              <h4 style={{ fontSize: '13px', fontWeight: 600, color: 'var(--success)', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Key Strengths</h4>
              {projection.strengths.map((s, i) => (
                <div key={i} style={{ display: 'flex', alignItems: 'flex-start', gap: '8px', marginBottom: '6px', fontSize: '13px', color: 'var(--text-secondary)' }}>
                  <span style={{ color: 'var(--success)', flexShrink: 0 }}>✓</span> {s}
                </div>
              ))}
            </div>
          )}
          {projection.risks && projection.risks.length > 0 && (
            <div style={{ marginTop: '16px' }}>
              <h4 style={{ fontSize: '13px', fontWeight: 600, color: 'var(--warning)', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Risks to Watch</h4>
              {projection.risks.map((r, i) => (
                <div key={i} style={{ display: 'flex', alignItems: 'flex-start', gap: '8px', marginBottom: '6px', fontSize: '13px', color: 'var(--text-secondary)' }}>
                  <span style={{ color: 'var(--warning)', flexShrink: 0 }}>⚠</span> {r}
                </div>
              ))}
            </div>
          )}
        </div>
      );
    };

    // ============================================
    // AGENT DEFINITIONS
    // ============================================
    const AGENTS = [
      {
        id: 'brainstorm', name: 'Idea Brainstorming', shortName: 'Idea',
        description: 'Transform rough concepts into refined app ideas',
        icon: Icons.Lightbulb, color: '#f59e0b', bgColor: 'rgba(245, 158, 11, 0.15)',
        order: 1, nextAgent: 'features', prevAgent: null,
        fields: [
          { name: 'concept', label: 'Describe your app idea', type: 'textarea', placeholder: 'What problem does your app solve? Who is it for?' },
          { name: 'inspiration', label: 'Any apps that inspired you?', type: 'text', placeholder: 'e.g., "Something like Notion meets Trello"' },
          { name: 'audience', label: 'Target audience', type: 'text', placeholder: 'Who will use this app?' },
        ],
        buildPrompt: (sl) => ({ beginner: 'You are a friendly app idea coach. Help users develop their app ideas step by step. Explain concepts simply.', intermediate: 'You are an app ideation specialist. Help refine app concepts by exploring target audiences and unique value propositions.', advanced: 'You are a senior product strategist. Analyze app concepts for market viability and competitive differentiation.' }[sl]),
        buildUserMessage: (fd, ctx) => `Please help me develop this app idea:\n\nConcept: ${fd.concept || 'Not specified'}\nInspiration: ${fd.inspiration || 'Not specified'}\nTarget Audience: ${fd.audience || 'Not specified'}\n\nPlease provide:\n1. A refined version of the app concept\n2. Key value propositions\n3. Target user personas\n4. Potential challenges and how to address them\n5. A catchy name suggestion for the app`,
      },
      {
        id: 'features', name: 'Feature Planning', shortName: 'Features',
        description: 'Break down your app into organized features',
        icon: Icons.List, color: '#22c55e', bgColor: 'rgba(34, 197, 94, 0.15)',
        order: 2, nextAgent: 'wireframe', prevAgent: 'brainstorm',
        fields: [
          { name: 'additionalFeatures', label: 'Any specific features you want?', type: 'textarea', placeholder: 'List any must-have features' },
          { name: 'constraints', label: 'Constraints or requirements', type: 'text', placeholder: 'e.g., "Must work offline"' },
        ],
        buildPrompt: (sl) => ({ beginner: 'You are a helpful feature planning assistant. Break down app ideas into simple features.', intermediate: 'You are a product manager. Create organized feature lists with priorities.', advanced: 'You are a technical product lead. Create comprehensive feature specs with user stories and dependencies.' }[sl]),
        buildUserMessage: (fd, ctx) => `${ctx.brainstorm ? `Based on our ideation:\n${ctx.brainstorm}\n\n` : ''}Please create a feature plan.\n\nAdditional features: ${fd.additionalFeatures || 'None'}\nConstraints: ${fd.constraints || 'None'}\n\nProvide:\n1. Core features (MVP)\n2. Secondary features (nice to have)\n3. Future features (post-launch)`,
      },
      {
        id: 'wireframe', name: 'Wireframing & UI', shortName: 'UI Design',
        description: 'Generate visual layouts and UI descriptions',
        icon: Icons.Layout, color: '#6366f1', bgColor: 'rgba(99, 102, 241, 0.15)',
        order: 3, nextAgent: 'architecture', prevAgent: 'features',
        fields: [
          { name: 'screens', label: 'Which screens to design?', type: 'textarea', placeholder: 'List main screens (or leave blank to auto-suggest)' },
          { name: 'style', label: 'Design style', type: 'select', options: ['Modern & Clean', 'Playful & Colorful', 'Professional & Corporate', 'Minimal & Elegant', 'Bold & Dynamic'] },
        ],
        buildPrompt: (sl) => ({ beginner: 'You are a friendly UI design assistant. Describe screens in simple terms with ASCII wireframes.', intermediate: 'You are a UI/UX designer. Create detailed wireframe descriptions with layouts and user flow.', advanced: 'You are a senior product designer. Provide comprehensive UI specs with component architecture.' }[sl]),
        buildUserMessage: (fd, ctx) => `${ctx.brainstorm ? `App Concept:\n${ctx.brainstorm}\n\n` : ''}${ctx.features ? `Features:\n${ctx.features}\n\n` : ''}Design the UI.\n\nScreens: ${fd.screens || 'Suggest based on features'}\nStyle: ${fd.style || 'Modern & Clean'}\n\nProvide:\n1. List of screens needed\n2. Layout and elements for each\n3. ASCII wireframes\n4. Navigation flow`,
      },
      {
        id: 'architecture', name: 'Architecture Advisor', shortName: 'Architecture',
        description: 'Get tech stack and system design recommendations',
        icon: Icons.Cpu, color: '#8b5cf6', bgColor: 'rgba(139, 92, 246, 0.15)',
        order: 4, nextAgent: 'codegen', prevAgent: 'wireframe',
        fields: [
          { name: 'appType', label: 'Platform', type: 'select', options: ['Web App', 'Mobile App (iOS)', 'Mobile App (Android)', 'Cross-platform Mobile', 'Desktop App', 'API / Backend'] },
          { name: 'scale', label: 'Expected scale', type: 'select', options: ['Just me / Prototype', 'Small team (<100 users)', 'Medium (100-10k users)', 'Large (10k+ users)'] },
          { name: 'teamExperience', label: 'Team experience', type: 'select', options: ['Beginner', 'Some experience', 'Experienced developers'] },
        ],
        buildPrompt: (sl) => ({ beginner: 'You are a patient tech advisor. Explain technology choices simply.', intermediate: 'You are a solutions architect. Recommend tech stacks with tradeoff explanations.', advanced: 'You are a principal engineer. Provide comprehensive architecture with scalability and security.' }[sl]),
        buildUserMessage: (fd, ctx) => `${ctx.brainstorm ? `App Concept:\n${ctx.brainstorm}\n\n` : ''}${ctx.features ? `Features:\n${ctx.features}\n\n` : ''}Recommend architecture.\n\nPlatform: ${fd.appType || 'Web App'}\nScale: ${fd.scale || 'Small'}\nTeam: ${fd.teamExperience || 'Some experience'}\n\nProvide:\n1. Tech stack\n2. Why each choice\n3. System architecture\n4. Scaling strategies`,
      },
      {
        id: 'codegen', name: 'Code Generation', shortName: 'Code',
        description: 'Generate working code and components',
        icon: Icons.Code, color: '#ec4899', bgColor: 'rgba(236, 72, 153, 0.15)',
        order: 5, nextAgent: 'project', prevAgent: 'architecture',
        fields: [
          { name: 'component', label: 'What to generate?', type: 'textarea', placeholder: 'Describe the component or feature' },
          { name: 'language', label: 'Language / Framework', type: 'select', options: ['Auto-detect from architecture', 'JavaScript / React', 'TypeScript / React', 'Python', 'Node.js / Express', 'Swift (iOS)', 'Kotlin (Android)', 'HTML / CSS'] },
        ],
        buildPrompt: (sl) => ({ beginner: 'You are a coding tutor. Write clean, well-commented code that teaches.', intermediate: 'You are a full-stack developer. Write production-quality code with error handling.', advanced: 'You are a senior engineer. Write optimized, production-ready code with best practices.' }[sl]),
        buildUserMessage: (fd, ctx) => `${ctx.architecture ? `Architecture:\n${ctx.architecture}\n\n` : ''}${ctx.features ? `Features:\n${ctx.features}\n\n` : ''}${ctx.wireframe ? `UI Design:\n${ctx.wireframe}\n\n` : ''}Generate code.\n\nComponent: ${fd.component || 'Core project structure'}\nLanguage: ${fd.language === 'Auto-detect from architecture' ? 'Based on architecture' : fd.language}\n\nProvide:\n1. File structure\n2. Working code\n3. How to run it\n4. Dependencies`,
      },
      {
        id: 'project', name: 'Project Management', shortName: 'Project',
        description: 'Create tasks, milestones, and timelines',
        icon: Icons.Calendar, color: '#06b6d4', bgColor: 'rgba(6, 182, 212, 0.15)',
        order: 6, nextAgent: null, prevAgent: 'codegen',
        fields: [
          { name: 'deadline', label: 'Target completion', type: 'select', options: ['ASAP / No deadline', '1 month', '3 months', '6 months', '1 year'] },
          { name: 'teamSize', label: 'Team size', type: 'select', options: ['Just me', '2-3 people', '4-6 people', '7+ people'] },
          { name: 'workStyle', label: 'Work style', type: 'select', options: ['Part-time / Side project', 'Full-time focus', 'Mixed availability'] },
        ],
        buildPrompt: (sl) => ({ beginner: 'You are a friendly project planning helper. Break down development into small tasks.', intermediate: 'You are a project manager. Create structured plans with milestones and dependencies.', advanced: 'You are a technical program manager. Create comprehensive roadmaps with sprint planning.' }[sl]),
        buildUserMessage: (fd, ctx) => `Based on everything planned:\n\n${ctx.brainstorm ? `Concept:\n${ctx.brainstorm}\n\n` : ''}${ctx.features ? `Features:\n${ctx.features}\n\n` : ''}${ctx.architecture ? `Architecture:\n${ctx.architecture}\n\n` : ''}Create a project plan.\n\nDeadline: ${fd.deadline || 'Flexible'}\nTeam: ${fd.teamSize || 'Just me'}\nWork style: ${fd.workStyle || 'Part-time'}\n\nProvide:\n1. Phases with milestones\n2. Task breakdown\n3. Time estimates\n4. Dependencies\n5. Risk factors`,
      },
    ];

    const SKILL_LEVELS = [
      { id: 'beginner', name: 'Beginner', description: 'Detailed explanations and guidance' },
      { id: 'intermediate', name: 'Intermediate', description: 'Balanced detail with best practices' },
      { id: 'advanced', name: 'Advanced', description: 'Concise and technical' },
    ];

    // ============================================
    // REUSABLE COMPONENTS
    // ============================================
    const Button = ({ children, variant = 'primary', size = 'md', disabled, loading, onClick, style = {} }) => {
      const [hovered, setHovered] = useState(false);
      const vs = { primary: styles.buttonPrimary, secondary: styles.buttonSecondary, ghost: styles.buttonGhost, success: styles.buttonSuccess };
      return (
        <button
          style={{ ...styles.button, ...vs[variant], ...(size === 'sm' ? { padding: '8px 16px', fontSize: '13px' } : {}), ...(size === 'lg' ? { padding: '16px 32px', fontSize: '16px' } : {}), ...(disabled || loading ? { opacity: 0.5, cursor: 'not-allowed' } : {}), ...(hovered && !disabled ? { transform: 'translateY(-1px)', opacity: 0.9 } : {}), ...style }}
          disabled={disabled || loading} onClick={onClick}
          onMouseEnter={() => setHovered(true)} onMouseLeave={() => setHovered(false)}
        >{loading ? <Icons.Loader /> : children}</button>
      );
    };

    const Input = ({ label, type = 'text', placeholder, value, onChange, options, style: s = {} }) => {
      const [focused, setFocused] = useState(false);
      const base = { ...styles.input, ...(focused ? styles.inputFocus : {}), ...s };
      if (type === 'select') return (
        <div style={{ marginBottom: '20px' }}>
          {label && <label style={styles.label}>{label}</label>}
          <select style={{ ...base, cursor: 'pointer' }} value={value} onChange={e => onChange(e.target.value)} onFocus={() => setFocused(true)} onBlur={() => setFocused(false)}>
            <option value="">Select an option</option>
            {options.map(o => <option key={o} value={o}>{o}</option>)}
          </select>
        </div>
      );
      if (type === 'textarea') return (
        <div style={{ marginBottom: '20px' }}>
          {label && <label style={styles.label}>{label}</label>}
          <textarea style={{ ...base, ...styles.textarea }} placeholder={placeholder} value={value} onChange={e => onChange(e.target.value)} onFocus={() => setFocused(true)} onBlur={() => setFocused(false)} />
        </div>
      );
      return (
        <div style={{ marginBottom: '20px' }}>
          {label && <label style={styles.label}>{label}</label>}
          <input type={type} style={base} placeholder={placeholder} value={value} onChange={e => onChange(e.target.value)} onFocus={() => setFocused(true)} onBlur={() => setFocused(false)} />
        </div>
      );
    };

    // ============================================
    // AUTH SCREEN (Real Supabase Auth)
    // ============================================
    const AuthScreen = ({ onAuth }) => {
      const [mode, setMode] = useState('login'); // login, signup, forgot, check-email
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [confirmPassword, setConfirmPassword] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      const handleLogin = async (e) => {
        e.preventDefault();
        if (!email || !password) { setError('Please fill in all fields'); return; }
        setLoading(true); setError('');
        try {
          const { data, error } = await supabase.auth.signInWithPassword({ email, password });
          if (error) throw error;
          onAuth(data.user);
        } catch (err) {
          setError(err.message);
        } finally { setLoading(false); }
      };

      const handleSignup = async (e) => {
        e.preventDefault();
        if (!email || !password || !confirmPassword) { setError('Please fill in all fields'); return; }
        if (password !== confirmPassword) { setError('Passwords do not match'); return; }
        if (password.length < 6) { setError('Password must be at least 6 characters'); return; }
        setLoading(true); setError('');
        try {
          const { data, error } = await supabase.auth.signUp({ email, password });
          if (error) throw error;
          if (data.user && !data.session) {
            setMode('check-email');
          } else {
            onAuth(data.user);
          }
        } catch (err) {
          setError(err.message);
        } finally { setLoading(false); }
      };

      const handleForgotPassword = async (e) => {
        e.preventDefault();
        if (!email) { setError('Please enter your email'); return; }
        setLoading(true); setError('');
        try {
          const { error } = await supabase.auth.resetPasswordForEmail(email, {
            redirectTo: window.location.origin,
          });
          if (error) throw error;
          setMode('check-email');
        } catch (err) {
          setError(err.message);
        } finally { setLoading(false); }
      };

      if (mode === 'check-email') {
        return (
          <div style={styles.authContainer}>
            <div style={styles.authCard} className="animate-fade-in auth-card">
              <div style={{ textAlign: 'center' }}>
                <div style={{ color: 'var(--accent)', marginBottom: '16px' }}><Icons.Mail /></div>
                <div style={{ ...styles.logoText, fontSize: '28px', marginBottom: '16px' }}>Check your email</div>
                <p style={{ color: 'var(--text-secondary)', marginBottom: '32px' }}>
                  We've sent a confirmation link to <strong style={{ color: 'var(--text-primary)' }}>{email}</strong>. Click the link in the email to continue.
                </p>
                <Button variant="secondary" onClick={() => { setMode('login'); setError(''); }}>
                  Back to Sign In
                </Button>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div style={styles.authContainer}>
          <div style={styles.authCard} className="animate-fade-in auth-card">
            <div style={{ textAlign: 'center', marginBottom: '32px' }}>
              <div style={{ ...styles.logoText, fontSize: '32px', marginBottom: '8px' }}>AI App Helper</div>
              <p style={{ color: 'var(--text-secondary)' }}>
                {mode === 'login' ? 'Welcome back! Sign in to continue.' : mode === 'signup' ? 'Create your free account.' : 'Reset your password.'}
              </p>
            </div>

            {error && (
              <div style={{ background: 'rgba(239, 68, 68, 0.15)', border: '1px solid var(--error)', borderRadius: 'var(--radius-md)', padding: '12px 16px', marginBottom: '24px', fontSize: '13px', color: 'var(--error)' }}>
                {error}
              </div>
            )}

            <form onSubmit={mode === 'login' ? handleLogin : mode === 'signup' ? handleSignup : handleForgotPassword}>
              <Input label="Email" type="email" placeholder="you@example.com" value={email} onChange={setEmail} />

              {mode !== 'forgot' && (
                <Input label="Password" type="password" placeholder="••••••••" value={password} onChange={setPassword} />
              )}

              {mode === 'signup' && (
                <Input label="Confirm Password" type="password" placeholder="••••••••" value={confirmPassword} onChange={setConfirmPassword} />
              )}

              {mode === 'login' && (
                <div style={{ textAlign: 'right', marginBottom: '16px' }}>
                  <button type="button" style={{ background: 'none', border: 'none', color: 'var(--accent)', cursor: 'pointer', fontSize: '13px', fontFamily: 'inherit' }} onClick={() => { setMode('forgot'); setError(''); }}>
                    Forgot password?
                  </button>
                </div>
              )}

              <Button variant="primary" loading={loading} style={{ width: '100%', marginTop: '8px' }}>
                {mode === 'login' ? 'Sign In' : mode === 'signup' ? 'Create Account' : 'Send Reset Link'}
              </Button>
            </form>

            <div style={{ textAlign: 'center', marginTop: '24px' }}>
              {mode === 'login' && (
                <button style={{ background: 'none', border: 'none', color: 'var(--accent)', cursor: 'pointer', fontSize: '14px', fontFamily: 'inherit' }} onClick={() => { setMode('signup'); setError(''); }}>
                  Don't have an account? Sign up
                </button>
              )}
              {mode === 'signup' && (
                <button style={{ background: 'none', border: 'none', color: 'var(--accent)', cursor: 'pointer', fontSize: '14px', fontFamily: 'inherit' }} onClick={() => { setMode('login'); setError(''); }}>
                  Already have an account? Sign in
                </button>
              )}
              {mode === 'forgot' && (
                <button style={{ background: 'none', border: 'none', color: 'var(--accent)', cursor: 'pointer', fontSize: '14px', fontFamily: 'inherit' }} onClick={() => { setMode('login'); setError(''); }}>
                  Back to Sign In
                </button>
              )}
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // PIPELINE PROGRESS
    // ============================================
    const PipelineProgress = ({ projectContext, currentAgent, onAgentClick }) => (
      <div className="pipeline-bar" style={{ display: 'flex', alignItems: 'center', gap: '8px', padding: '16px 24px', background: 'var(--bg-secondary)', borderRadius: 'var(--radius-lg)', marginBottom: '32px', overflowX: 'auto' }}>
        {AGENTS.map((agent, idx) => {
          const isComplete = !!projectContext[agent.id];
          const isCurrent = currentAgent === agent.id;
          const Icon = agent.icon;
          return (
            <React.Fragment key={agent.id}>
              {idx > 0 && <div style={{ width: '40px', height: '2px', background: isComplete || isCurrent ? agent.color : 'var(--border)', flexShrink: 0 }} />}
              <button onClick={() => onAgentClick(agent.id)} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '8px', padding: '12px 16px', background: isCurrent ? agent.bgColor : 'transparent', border: `2px solid ${isCurrent ? agent.color : isComplete ? agent.color : 'var(--border)'}`, borderRadius: 'var(--radius-md)', cursor: 'pointer', transition: 'all 0.2s ease', minWidth: '100px' }}>
                <div style={{ width: '32px', height: '32px', borderRadius: '50%', background: isComplete ? agent.color : agent.bgColor, color: isComplete ? 'white' : agent.color, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                  {isComplete ? <Icons.Check /> : <Icon />}
                </div>
                <span style={{ fontSize: '12px', fontWeight: 600, color: isCurrent ? agent.color : isComplete ? 'var(--text-primary)' : 'var(--text-muted)', whiteSpace: 'nowrap' }}>{agent.shortName}</span>
              </button>
            </React.Fragment>
          );
        })}
      </div>
    );

    // ============================================
    // CONTEXT SUMMARY
    // ============================================
    const ContextSummary = ({ projectContext, onViewOutput }) => {
      const completed = AGENTS.filter(a => projectContext[a.id]);
      if (completed.length === 0) return null;
      return (
        <div style={{ background: 'var(--bg-secondary)', borderRadius: 'var(--radius-lg)', border: '1px solid var(--border)', padding: '20px', marginBottom: '24px' }}>
          <h4 style={{ fontSize: '14px', fontWeight: 600, color: 'var(--text-secondary)', marginBottom: '16px' }}>Project Context ({completed.length}/{AGENTS.length} complete)</h4>
          <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
            {completed.map(agent => { const Icon = agent.icon; return (
              <button key={agent.id} onClick={() => onViewOutput(agent.id)} style={{ display: 'flex', alignItems: 'center', gap: '6px', padding: '6px 12px', background: agent.bgColor, border: `1px solid ${agent.color}`, borderRadius: '100px', color: agent.color, fontSize: '13px', fontWeight: 500, cursor: 'pointer' }}>
                <Icon /> {agent.shortName}
              </button>
            ); })}
          </div>
        </div>
      );
    };

    // ============================================
    // OUTPUT MODAL
    // ============================================
    const OutputModal = ({ agent, content, onClose }) => {
      if (!agent) return null;
      const Icon = agent.icon;
      return (
        <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.8)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '24px' }} onClick={onClose}>
          <div style={{ background: 'var(--bg-secondary)', borderRadius: 'var(--radius-xl)', border: '1px solid var(--border)', maxWidth: '800px', width: '100%', maxHeight: '80vh', overflow: 'hidden', display: 'flex', flexDirection: 'column', position: 'relative' }} onClick={e => e.stopPropagation()}>
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '20px 24px', borderBottom: '1px solid var(--border)' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                <div style={{ width: '40px', height: '40px', borderRadius: 'var(--radius-md)', background: agent.bgColor, color: agent.color, display: 'flex', alignItems: 'center', justifyContent: 'center' }}><Icon /></div>
                <h3 style={{ fontSize: '18px', fontWeight: 600 }}>{agent.name} Output</h3>
              </div>
              <div style={{ display: 'flex', gap: '8px' }}>
                <CopyButton text={content} inline />
                <Button variant="ghost" size="sm" onClick={onClose}>Close</Button>
              </div>
            </div>
            <div style={{ padding: '24px', overflow: 'auto', flex: 1 }}>
              <MarkdownOutput text={content} />
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // SKILL LEVEL SELECTOR
    // ============================================
    const SkillLevelSelector = ({ selected, onSelect }) => (
      <div className="skill-grid" style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px' }}>
        {SKILL_LEVELS.map(level => (
          <div key={level.id} style={{ ...styles.card, cursor: 'pointer', borderColor: selected === level.id ? 'var(--accent)' : 'var(--border)', background: selected === level.id ? 'var(--accent-muted)' : 'var(--bg-secondary)', padding: '16px' }} onClick={() => onSelect(level.id)}>
            <div style={{ width: '20px', height: '20px', borderRadius: '50%', border: `2px solid ${selected === level.id ? 'var(--accent)' : 'var(--border-light)'}`, marginBottom: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center', background: selected === level.id ? 'var(--accent)' : 'transparent' }}>
              {selected === level.id && <Icons.Check />}
            </div>
            <h3 style={{ fontSize: '14px', fontWeight: 600, color: selected === level.id ? 'var(--accent)' : 'var(--text-primary)' }}>{level.name}</h3>
            <p style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '2px' }}>{level.description}</p>
          </div>
        ))}
      </div>
    );

    // ============================================
    // SIDEBAR
    // ============================================
    const Sidebar = ({ currentView, setCurrentView, currentProject, user, onLogout }) => {
      const [hoveredItem, setHoveredItem] = useState(null);
      const NavItem = ({ id, icon: Icon, label, badge }) => {
        const isActive = currentView === id;
        const isHovered = hoveredItem === id;
        return (
          <button style={{ ...styles.navItem, ...(isActive ? styles.navItemActive : {}), ...(isHovered && !isActive ? styles.navItemHover : {}) }}
            onClick={() => setCurrentView(id)} onMouseEnter={() => setHoveredItem(id)} onMouseLeave={() => setHoveredItem(null)}>
            <Icon /><span style={{ flex: 1 }}>{label}</span>
            {badge && <span style={{ ...styles.badge, ...styles.badgeSuccess, padding: '2px 8px' }}>{badge}</span>}
          </button>
        );
      };
      return (
        <div style={styles.sidebar}>
          <div style={styles.logo}><div style={styles.logoText}>AI App Helper</div></div>
          <nav style={styles.nav}>
            <div style={styles.navSection}>
              <div style={styles.navLabel}>Main</div>
              <NavItem id="dashboard" icon={Icons.Sparkles} label="Dashboard" />
              <NavItem id="projects" icon={Icons.Folder} label="My Projects" />
            </div>
            {currentProject && (
              <div style={styles.navSection}>
                <div style={styles.navLabel}>Current Project</div>
                <NavItem id="workflow" icon={Icons.Workflow} label="Workflow" />
                {AGENTS.map(agent => <NavItem key={agent.id} id={`agent-${agent.id}`} icon={agent.icon} label={agent.name} badge={currentProject.context?.[agent.id] ? '✓' : null} />)}
              </div>
            )}
            <div style={styles.navSection}>
              <div style={styles.navLabel}>Account</div>
              <NavItem id="settings" icon={Icons.Settings} label="Settings" />
            </div>
          </nav>
          <div style={{ padding: '16px', borderTop: '1px solid var(--border)' }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px' }}>
              <div style={{ width: '36px', height: '36px', borderRadius: '50%', background: 'var(--gradient-1)', display: 'flex', alignItems: 'center', justifyContent: 'center' }}><Icons.User /></div>
              <div style={{ flex: 1, overflow: 'hidden' }}>
                <div style={{ fontSize: '14px', fontWeight: 500, whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{user?.email}</div>
              </div>
            </div>
            <Button variant="ghost" size="sm" onClick={onLogout} style={{ width: '100%', justifyContent: 'flex-start' }}><Icons.LogOut /> Sign Out</Button>
          </div>
        </div>
      );
    };

    // ============================================
    // DASHBOARD
    // ============================================
    const Dashboard = ({ setCurrentView, projects, setCurrentProject, createProject, loadingProjects }) => {
      const [showNew, setShowNew] = useState(false);
      const [name, setName] = useState('');
      const handleCreate = () => { if (!name.trim()) return; createProject(name); setName(''); setShowNew(false); };
      return (
        <div>
          <div className="animate-fade-in">
            <h1 style={styles.h1}>Welcome back</h1>
            <p style={{ color: 'var(--text-secondary)', fontSize: '18px', marginBottom: '32px' }}>Start a new project or continue where you left off.</p>
          </div>
          <div style={{ display: 'flex', gap: '16px', marginBottom: '48px' }} className="animate-fade-in stagger-1">
            <Button variant="primary" onClick={() => setShowNew(true)}><Icons.Plus /> New Project</Button>
          </div>
          {showNew && (
            <div style={{ ...styles.card, marginBottom: '32px' }} className="animate-fade-in">
              <h3 style={{ ...styles.h2, marginBottom: '16px' }}>Create New Project</h3>
              <div style={{ display: 'flex', gap: '12px', alignItems: 'flex-end' }}>
                <div style={{ flex: 1 }}><Input placeholder="My Awesome App" value={name} onChange={setName} style={{ marginBottom: 0 }} /></div>
                <Button variant="primary" onClick={handleCreate}>Create</Button>
                <Button variant="secondary" onClick={() => setShowNew(false)}>Cancel</Button>
              </div>
            </div>
          )}
          <h2 style={{ ...styles.h2, marginBottom: '24px' }} className="animate-fade-in stagger-2">Your Projects</h2>
          {loadingProjects ? (
            <div style={{ textAlign: 'center', padding: '64px', color: 'var(--text-muted)' }}><Icons.Loader /><p style={{ marginTop: '16px' }}>Loading projects...</p></div>
          ) : projects.length === 0 ? (
            <div style={{ ...styles.card, textAlign: 'center', padding: '64px' }} className="animate-fade-in stagger-3">
              <div style={{ color: 'var(--text-muted)', marginBottom: '16px' }}><Icons.Folder /></div>
              <h3 style={styles.h3}>No projects yet</h3>
              <p style={{ color: 'var(--text-secondary)', marginTop: '8px' }}>Create your first project to start building!</p>
            </div>
          ) : (
            <div className="landing-grid-2" style={{ ...styles.grid, gridTemplateColumns: 'repeat(2, 1fr)' }}>
              {projects.map((project, idx) => {
                const completed = AGENTS.filter(a => project.context?.[a.id]).length;
                return (
                  <div key={project.id} style={{ ...styles.card, cursor: 'pointer' }} className={`hover-card animate-fade-in stagger-${Math.min(idx + 3, 6)}`}
                    onClick={() => { setCurrentProject(project); setCurrentView('workflow'); }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                      <div>
                        <h3 style={styles.h3}>{project.name}</h3>
                        <p style={{ fontSize: '13px', color: 'var(--text-muted)', marginTop: '4px' }}>
                          {completed}/{AGENTS.length} stages • Started {timeAgo(project.created_at)}
                        </p>
                      </div>
                      {project.context?._completed_at ? <span style={{ ...styles.badge, background: 'rgba(99, 102, 241, 0.15)', color: 'var(--accent)' }}>Completed</span> : completed === AGENTS.length ? <span style={{ ...styles.badge, ...styles.badgeSuccess }}>Ready to Complete</span> : completed > 0 ? <span style={{ ...styles.badge, ...styles.badgeWarning }}>In Progress</span> : <span style={{ ...styles.badge, ...styles.badgeMuted }}>New</span>}
                    </div>
                    <div style={{ display: 'flex', gap: '4px', marginTop: '16px' }}>
                      {AGENTS.map(a => <div key={a.id} style={{ flex: 1, height: '4px', borderRadius: '2px', background: project.context?.[a.id] ? a.color : 'var(--border)' }} />)}
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      );
    };

    // ============================================
    // WORKFLOW VIEW
    // ============================================
    const WorkflowView = ({ project, setCurrentView, updateProject, user }) => {
      const completed = AGENTS.filter(a => project.context?.[a.id]);
      const nextAgent = AGENTS.find(a => !project.context?.[a.id]);
      const allDone = completed.length === AGENTS.length;
      const isCompleted = !!project.context?._completed_at;
      const projection = project.context?._projection;
      const [completing, setCompleting] = useState(false);
      const toast = useToast();

      const handleComplete = async () => {
        setCompleting(true);
        try {
          const allOutputs = AGENTS.map(a => `--- ${a.name} ---\n${project.context[a.id]}`).join('\n\n');
          const res = await fetch('/api/messages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 2048,
              system: 'You are a project evaluation expert. Analyze the complete app development outputs and provide a JSON projection. Be honest and constructive. Return ONLY valid JSON, no markdown fences, no explanation.',
              messages: [{ role: 'user', content: `Analyze this completed app project and rate it. Here are all the development outputs:\n\n${allOutputs}\n\nReturn ONLY a JSON object with this exact structure:\n{"overall": <0-100>, "viability": <0-100>, "usefulness": <0-100>, "market": <0-100>, "innovation": <0-100>, "summary": "<2-3 sentence overall assessment>", "strengths": ["<strength 1>", "<strength 2>", "<strength 3>"], "risks": ["<risk 1>", "<risk 2>", "<risk 3>"]}` }],
            }),
          });
          if (!res.ok) throw new Error('API error');
          const data = await res.json();
          let projectionData;
          try {
            const text = data.content[0].text.replace(/```json|```/g, '').trim();
            projectionData = JSON.parse(text);
          } catch (e) {
            projectionData = { overall: 70, viability: 70, usefulness: 70, market: 65, innovation: 65, summary: 'Project evaluation complete. All stages have been filled in successfully.', strengths: ['Complete workflow coverage', 'Well-structured development process'], risks: ['Market validation still needed', 'Technical complexity may increase'] };
          }
          const updatedContext = { ...project.context, _completed_at: new Date().toISOString(), _projection: projectionData };
          await updateProject({ ...project, context: updatedContext });
          toast('Project completed! Projection generated.', 'success');
        } catch (err) {
          console.error('Projection failed:', err);
          toast('Failed to generate projection. Try again.', 'error');
        }
        setCompleting(false);
      };

      return (
        <div>
          <div className="animate-fade-in">
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '8px' }}>
              <h1 style={styles.h1}>{project.name}</h1>
              {isCompleted && <span style={{ ...styles.badge, background: 'rgba(99, 102, 241, 0.15)', color: 'var(--accent)', padding: '6px 14px', fontSize: '13px' }}>✓ Completed</span>}
            </div>
            <div style={{ display: 'flex', gap: '16px', alignItems: 'center', color: 'var(--text-secondary)', fontSize: '14px', marginBottom: '32px' }}>
              <span>Started {formatDate(project.created_at)}</span>
              <span style={{ color: 'var(--border)' }}>•</span>
              <span>{completed.length}/{AGENTS.length} stages complete</span>
              {isCompleted && (
                <React.Fragment>
                  <span style={{ color: 'var(--border)' }}>•</span>
                  <span>Completed {formatDate(project.context._completed_at)}</span>
                </React.Fragment>
              )}
            </div>
          </div>

          {/* Projection scorecard if completed */}
          {projection && <div style={{ marginBottom: '32px' }}><ProjectionCard projection={projection} /></div>}

          {/* Complete button if all stages done but not yet completed */}
          {allDone && !isCompleted && (
            <div style={{ ...styles.card, background: 'var(--accent-muted)', borderColor: 'var(--accent)', marginBottom: '32px', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }} className="animate-fade-in">
              <div>
                <h3 style={{ fontSize: '16px', fontWeight: 600, marginBottom: '4px' }}>All stages complete!</h3>
                <p style={{ fontSize: '14px', color: 'var(--text-secondary)' }}>Mark this project as done and get an AI projection of its potential.</p>
              </div>
              <Button variant="primary" onClick={handleComplete} disabled={completing}>
                {completing ? <><Icons.Loader style={{ animation: 'spin 1s linear infinite' }} /> Analyzing...</> : <><Icons.Sparkles /> Complete Project</>}
              </Button>
            </div>
          )}

          <PipelineProgress projectContext={project.context || {}} currentAgent={null} onAgentClick={id => setCurrentView(`agent-${id}`)} />
          <div className="landing-grid-2" style={{ ...styles.grid, gridTemplateColumns: 'repeat(2, 1fr)' }}>
            {AGENTS.map((agent, idx) => {
              const isComplete = project.context?.[agent.id];
              const isNext = agent.id === nextAgent?.id;
              const Icon = agent.icon;
              return (
                <div key={agent.id} className={`hover-card-glow animate-fade-in stagger-${Math.min(idx + 1, 6)}`}
                  style={{ ...styles.card, cursor: 'pointer', borderColor: isComplete ? agent.color : isNext ? 'var(--accent)' : 'var(--border)', position: 'relative' }}
                  onClick={() => setCurrentView(`agent-${agent.id}`)}>
                  {isNext && <div style={{ position: 'absolute', top: '-10px', right: '16px', background: 'var(--accent)', color: 'white', padding: '4px 12px', borderRadius: '100px', fontSize: '11px', fontWeight: 600 }}>NEXT STEP</div>}
                  <div style={{ display: 'flex', alignItems: 'flex-start', gap: '16px' }}>
                    <div style={{ width: '48px', height: '48px', borderRadius: 'var(--radius-md)', background: isComplete ? agent.color : agent.bgColor, color: isComplete ? 'white' : agent.color, display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0 }}>
                      {isComplete ? <Icons.Check /> : <Icon />}
                    </div>
                    <div style={{ flex: 1 }}>
                      <span style={{ fontSize: '12px', color: 'var(--text-muted)', fontWeight: 600 }}>STEP {agent.order}</span>
                      <h3 style={{ ...styles.h3, marginTop: '4px' }}>{agent.name}</h3>
                      <p style={{ fontSize: '13px', color: 'var(--text-secondary)', marginTop: '4px' }}>{agent.description}</p>
                    </div>
                  </div>
                  {isComplete && <div style={{ marginTop: '16px', padding: '12px', background: 'var(--bg-elevated)', borderRadius: 'var(--radius-md)', fontSize: '13px', color: 'var(--text-secondary)', maxHeight: '80px', overflow: 'hidden' }}>{project.context[agent.id].substring(0, 200)}...</div>}
                </div>
              );
            })}
          </div>
        </div>
      );
    };

    // ============================================
    // AGENT VIEW
    // ============================================
    const DAILY_LIMIT = 10;

    const AgentView = ({ agent, project, updateProject, skillLevel, setCurrentView, user }) => {
      const [formData, setFormData] = useState({});
      const [response, setResponse] = useState(project.context?.[agent.id] || '');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [viewingAgent, setViewingAgent] = useState(null);
      const [usageCount, setUsageCount] = useState(0);
      const [usageLoaded, setUsageLoaded] = useState(false);

      // Load today's usage count for this specific agent
      useEffect(() => {
        if (!user) return;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        supabase.from('usage').select('id', { count: 'exact' })
          .eq('user_id', user.id)
          .eq('agent_id', agent.id)
          .gte('created_at', today.toISOString())
          .then(({ count }) => {
            setUsageCount(count || 0);
            setUsageLoaded(true);
          });
      }, [user, agent.id]);

      const handleSubmit = async () => {
        // Check usage limit
        if (usageCount >= DAILY_LIMIT) {
          setError(`Daily limit reached (${DAILY_LIMIT} per agent per day). Try again tomorrow!`);
          return;
        }

        setLoading(true); setError(''); setResponse('');
        const ctx = project.context || {};
        const systemPrompt = agent.buildPrompt(skillLevel);
        const userMessage = agent.buildUserMessage(formData, ctx);
        try {
          const res = await fetch('/api/messages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 4096, system: systemPrompt, messages: [{ role: 'user', content: userMessage }] }),
          });
          if (!res.ok) { const d = await res.json().catch(() => ({})); throw new Error(d.error?.message || `API error: ${res.status}`); }
          const data = await res.json();
          const output = data.content[0].text;
          setResponse(output);
          updateProject({ ...project, context: { ...project.context, [agent.id]: output } });

          // Record usage with agent_id
          await supabase.from('usage').insert({ user_id: user.id, agent_id: agent.id });
          setUsageCount(prev => prev + 1);
        } catch (err) {
          setError(err.message === 'Failed to fetch' ? 'Network error. Please try again.' : err.message);
        } finally { setLoading(false); }
      };

      const Icon = agent.icon;
      const hasOutput = !!project.context?.[agent.id];

      return (
        <div>
          <button onClick={() => setCurrentView('workflow')} style={{ ...styles.button, ...styles.buttonGhost, padding: '8px 0', marginBottom: '24px' }}><Icons.ChevronLeft /> Back to Workflow</button>
          <PipelineProgress projectContext={project.context || {}} currentAgent={agent.id} onAgentClick={id => setCurrentView(`agent-${id}`)} />
          <div style={{ display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '24px' }} className="animate-fade-in">
            <div style={{ width: '56px', height: '56px', borderRadius: 'var(--radius-md)', background: agent.bgColor, color: agent.color, display: 'flex', alignItems: 'center', justifyContent: 'center' }}><Icon /></div>
            <div>
              <div style={{ fontSize: '12px', color: 'var(--text-muted)', fontWeight: 600 }}>STEP {agent.order} OF {AGENTS.length}</div>
              <h1 style={{ ...styles.h1, fontSize: '32px', marginBottom: '4px' }}>{agent.name}</h1>
            </div>
          </div>
          <ContextSummary projectContext={project.context || {}} onViewOutput={id => setViewingAgent(AGENTS.find(a => a.id === id))} />
          <div className="agent-grid" style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '32px' }}>
            <div className="animate-fade-in stagger-1">
              <div style={styles.card}>
                <h3 style={{ ...styles.h2, marginBottom: '24px' }}>Input</h3>
                {agent.fields.map(f => <Input key={f.name} label={f.label} type={f.type} placeholder={f.placeholder} options={f.options} value={formData[f.name] || ''} onChange={v => setFormData(p => ({ ...p, [f.name]: v }))} />)}
                <div style={{ display: 'flex', alignItems: 'center', gap: '16px', marginTop: '8px' }}>
                  <Button variant="primary" loading={loading} onClick={handleSubmit} disabled={usageCount >= DAILY_LIMIT}><Icons.Sparkles /> {hasOutput ? 'Regenerate' : 'Generate'}</Button>
                  {usageLoaded && (
                    <span style={{ fontSize: '13px', color: usageCount >= DAILY_LIMIT ? 'var(--error)' : 'var(--text-muted)' }}>
                      {DAILY_LIMIT - usageCount} / {DAILY_LIMIT} generations left today
                    </span>
                  )}
                </div>
                {error && <div style={{ marginTop: '16px', padding: '12px 16px', background: 'rgba(239, 68, 68, 0.15)', border: '1px solid var(--error)', borderRadius: 'var(--radius-md)', color: 'var(--error)', fontSize: '13px' }}>{error}</div>}
              </div>
            </div>
            <div className="animate-fade-in stagger-2">
              <div style={{ ...styles.card, minHeight: '400px', display: 'flex', flexDirection: 'column', position: 'relative' }}>
                <h3 style={{ ...styles.h2, marginBottom: '24px' }}>Output</h3>
                {response && <CopyButton text={response} />}
                <div style={{ flex: 1 }}>
                  {loading ? (
                    <div>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '20px', color: 'var(--accent)' }}>
                        <div style={{ animation: 'spin 1s linear infinite' }}><Icons.Loader /></div>
                        <span style={{ fontSize: '14px', fontWeight: 500 }}>Generating with AI...</span>
                      </div>
                      <LoadingSkeleton />
                    </div>
                  ) : response ? (
                    <MarkdownOutput text={response} />
                  ) : (
                    <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', height: '300px', color: 'var(--text-muted)', textAlign: 'center' }}>
                      <Icons.Sparkles /><p style={{ marginTop: '16px' }}>{Object.keys(project.context || {}).length > 0 ? 'Previous stages will be used as context' : 'Fill out the form and click Generate'}</p>
                    </div>
                  )}
                </div>
                {response && (
                  <div style={{ display: 'flex', gap: '12px', marginTop: '24px', paddingTop: '24px', borderTop: '1px solid var(--border)' }}>
                    {agent.prevAgent && <Button variant="ghost" onClick={() => setCurrentView(`agent-${agent.prevAgent}`)}><Icons.ChevronLeft /> Previous</Button>}
                    <div style={{ flex: 1 }} />
                    {agent.nextAgent ? <Button variant="success" onClick={() => setCurrentView(`agent-${agent.nextAgent}`)}>Continue to {AGENTS.find(a => a.id === agent.nextAgent)?.shortName} <Icons.ChevronRight /></Button>
                    : <Button variant="success" onClick={() => setCurrentView('workflow')}><Icons.Check /> Complete</Button>}
                  </div>
                )}
              </div>
            </div>
          </div>
          {viewingAgent && <OutputModal agent={viewingAgent} content={project.context?.[viewingAgent.id]} onClose={() => setViewingAgent(null)} />}
        </div>
      );
    };

    // ============================================
    // PROJECTS VIEW
    // ============================================
    const ProjectsView = ({ projects, deleteProject, setCurrentProject, setCurrentView, loadingProjects }) => {
      const [showNew, setShowNew] = useState(false);
      const [name, setName] = useState('');
      return (
        <div>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '32px' }} className="animate-fade-in">
            <div><h1 style={styles.h1}>My Projects</h1><p style={{ color: 'var(--text-secondary)' }}>Manage your app development projects</p></div>
          </div>
          {loadingProjects ? (
            <div style={{ textAlign: 'center', padding: '64px', color: 'var(--text-muted)' }}><Icons.Loader /></div>
          ) : projects.length === 0 ? (
            <div style={{ ...styles.card, textAlign: 'center', padding: '64px' }} className="animate-fade-in stagger-1">
              <div style={{ color: 'var(--text-muted)', marginBottom: '16px' }}><Icons.Folder /></div>
              <h3 style={styles.h3}>No projects yet</h3>
            </div>
          ) : (
            <div className="landing-grid-2" style={{ ...styles.grid, gridTemplateColumns: 'repeat(2, 1fr)' }}>
              {projects.map((project, idx) => {
                const completed = AGENTS.filter(a => project.context?.[a.id]).length;
                return (
                  <div key={project.id} style={styles.card} className={`animate-fade-in stagger-${Math.min(idx + 1, 6)}`}>
                    <div style={{ display: 'flex', alignItems: 'flex-start', justifyContent: 'space-between' }}>
                      <div style={{ cursor: 'pointer', flex: 1 }} onClick={() => { setCurrentProject(project); setCurrentView('workflow'); }}>
                        <h3 style={styles.h3}>{project.name}</h3>
                        <p style={{ fontSize: '13px', color: 'var(--text-muted)', marginTop: '4px' }}>
                          {completed}/{AGENTS.length} stages • Started {formatDate(project.created_at)}
                          {project.context?._completed_at && ` • Completed ${formatDate(project.context._completed_at)}`}
                        </p>
                        {project.context?._projection && (
                          <div style={{ display: 'inline-flex', alignItems: 'center', gap: '6px', marginTop: '8px', padding: '4px 10px', background: 'var(--bg-elevated)', borderRadius: '100px', fontSize: '12px', fontWeight: 600 }}>
                            <span style={{ color: project.context._projection.overall >= 70 ? 'var(--success)' : project.context._projection.overall >= 50 ? 'var(--warning)' : 'var(--error)' }}>
                              Score: {project.context._projection.overall}/100
                            </span>
                          </div>
                        )}
                      </div>
                      <Button variant="ghost" size="sm" onClick={() => deleteProject(project.id)} style={{ color: 'var(--error)' }}><Icons.Trash /></Button>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      );
    };

    // ============================================
    // SETTINGS VIEW
    // ============================================
    const SettingsView = ({ skillLevel, setSkillLevel }) => (
      <div>
        <div className="animate-fade-in"><h1 style={styles.h1}>Settings</h1><p style={{ color: 'var(--text-secondary)', marginBottom: '48px' }}>Configure your preferences</p></div>
        <div style={{ maxWidth: '600px' }}>
          <div style={styles.card} className="animate-fade-in stagger-1">
            <h3 style={{ ...styles.h2, marginBottom: '8px' }}>Skill Level</h3>
            <p style={{ color: 'var(--text-secondary)', fontSize: '14px', marginBottom: '24px' }}>Affects how detailed the AI explanations will be</p>
            <SkillLevelSelector selected={skillLevel} onSelect={setSkillLevel} />
          </div>
        </div>
      </div>
    );

    // ============================================
    // LANDING PAGE
    // ============================================
    const LandingPage = ({ onAuth }) => {
      const [showAuth, setShowAuth] = useState(false);

      if (showAuth) return <AuthScreen onAuth={onAuth} />;

      const agents = [
        { icon: Icons.Lightbulb, color: '#f59e0b', bg: 'rgba(245, 158, 11, 0.15)', name: 'Idea Brainstorming', desc: 'Transform rough concepts into refined, viable app ideas' },
        { icon: Icons.List, color: '#22c55e', bg: 'rgba(34, 197, 94, 0.15)', name: 'Feature Planning', desc: 'Organize features into MVP, secondary, and future phases' },
        { icon: Icons.Layout, color: '#6366f1', bg: 'rgba(99, 102, 241, 0.15)', name: 'UI Design', desc: 'Generate wireframes and visual layout descriptions' },
        { icon: Icons.Cpu, color: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.15)', name: 'Architecture', desc: 'Get tech stack and system design recommendations' },
        { icon: Icons.Code, color: '#ec4899', bg: 'rgba(236, 72, 153, 0.15)', name: 'Code Generation', desc: 'Generate working code and project structure' },
        { icon: Icons.Calendar, color: '#06b6d4', bg: 'rgba(6, 182, 212, 0.15)', name: 'Project Management', desc: 'Create tasks, milestones, and realistic timelines' },
      ];

      return (
        <div style={{ minHeight: '100vh', background: 'var(--bg-primary)' }}>
          {/* Nav */}
          <nav style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '20px 48px', borderBottom: '1px solid var(--border)' }} className="landing-nav">
            <div style={{ ...styles.logoText, fontSize: '22px' }}>AI App Helper</div>
            <div style={{ display: 'flex', gap: '12px' }}>
              <Button variant="ghost" onClick={() => setShowAuth(true)}>Sign In</Button>
              <Button variant="primary" onClick={() => setShowAuth(true)}>Get Started Free</Button>
            </div>
          </nav>

          {/* Hero */}
          <section style={{ textAlign: 'center', padding: '100px 48px 80px', maxWidth: '900px', margin: '0 auto' }} className="animate-fade-in landing-section">
            <div style={{ display: 'inline-flex', alignItems: 'center', gap: '8px', padding: '8px 16px', background: 'var(--accent-muted)', borderRadius: '100px', fontSize: '13px', fontWeight: 600, color: 'var(--accent)', marginBottom: '24px' }}>
              <Icons.Sparkles /> Powered by AI
            </div>
            <h1 className="landing-hero-title" style={{ fontFamily: "'Instrument Serif', Georgia, serif", fontSize: '72px', fontWeight: 400, letterSpacing: '-0.03em', lineHeight: 1.05, marginBottom: '24px' }}>
              Build your app idea<br />
              <span style={{ fontStyle: 'italic', background: 'var(--gradient-1)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>from concept to code</span>
            </h1>
            <p className="landing-hero-subtitle" style={{ fontSize: '20px', color: 'var(--text-secondary)', maxWidth: '600px', margin: '0 auto 40px', lineHeight: 1.6 }}>
              6 AI-powered agents guide you through every step of app development — brainstorming, planning, design, architecture, coding, and project management.
            </p>
            <div style={{ display: 'flex', gap: '16px', justifyContent: 'center' }}>
              <Button variant="primary" size="lg" onClick={() => setShowAuth(true)}>
                <Icons.ArrowRight /> Start Building — It's Free
              </Button>
            </div>
          </section>

          {/* How it works */}
          <section style={{ padding: '80px 48px', maxWidth: '1100px', margin: '0 auto' }} className="landing-section">
            <div style={{ textAlign: 'center', marginBottom: '64px' }} className="animate-fade-in">
              <h2 style={{ fontFamily: "'Instrument Serif', Georgia, serif", fontSize: '44px', fontWeight: 400, letterSpacing: '-0.02em', marginBottom: '16px' }}>
                How it works
              </h2>
              <p style={{ fontSize: '18px', color: 'var(--text-secondary)', maxWidth: '500px', margin: '0 auto' }}>
                Each agent builds on the previous one, creating a connected workflow that turns your idea into a complete plan.
              </p>
            </div>

            {/* Agent pipeline visual */}
            <div className="landing-grid-3" style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '24px' }}>
              {agents.map((a, idx) => {
                const Icon = a.icon;
                return (
                  <div key={idx} style={{ ...styles.card, padding: '32px', position: 'relative' }} className={`hover-card animate-fade-in stagger-${Math.min(idx + 1, 6)}`}>
                    <div style={{ position: 'absolute', top: '16px', right: '16px', fontSize: '13px', fontWeight: 700, color: 'var(--text-muted)' }}>
                      {String(idx + 1).padStart(2, '0')}
                    </div>
                    <div style={{ width: '52px', height: '52px', borderRadius: 'var(--radius-md)', background: a.bg, color: a.color, display: 'flex', alignItems: 'center', justifyContent: 'center', marginBottom: '20px' }}>
                      <Icon />
                    </div>
                    <h3 style={{ fontSize: '18px', fontWeight: 600, marginBottom: '8px' }}>{a.name}</h3>
                    <p style={{ fontSize: '14px', color: 'var(--text-secondary)', lineHeight: 1.6 }}>{a.desc}</p>
                  </div>
                );
              })}
            </div>
          </section>

          {/* Features */}
          <section style={{ padding: '80px 48px', borderTop: '1px solid var(--border)' }} className="landing-section">
            <div style={{ maxWidth: '1100px', margin: '0 auto' }}>
              <div className="landing-grid-3" style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '48px' }}>
                {[
                  { title: 'Connected Workflow', desc: 'Each agent passes context to the next, so your architecture matches your features and your code matches your design.', icon: Icons.Workflow },
                  { title: 'Skill Level Adaptation', desc: 'Set your experience level and get explanations tailored to you — from beginner-friendly to advanced technical specs.', icon: Icons.User },
                  { title: 'Cloud Saved Projects', desc: 'Your projects are saved securely in the cloud. Pick up where you left off on any device.', icon: Icons.Folder },
                ].map((f, idx) => {
                  const Icon = f.icon;
                  return (
                    <div key={idx} style={{ textAlign: 'center' }} className={`animate-fade-in stagger-${idx + 1}`}>
                      <div style={{ width: '48px', height: '48px', borderRadius: '50%', background: 'var(--accent-muted)', color: 'var(--accent)', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 16px' }}>
                        <Icon />
                      </div>
                      <h3 style={{ fontSize: '18px', fontWeight: 600, marginBottom: '8px' }}>{f.title}</h3>
                      <p style={{ fontSize: '14px', color: 'var(--text-secondary)', lineHeight: 1.6 }}>{f.desc}</p>
                    </div>
                  );
                })}
              </div>
            </div>
          </section>

          {/* CTA */}
          <section style={{ padding: '80px 48px', textAlign: 'center', borderTop: '1px solid var(--border)' }} className="landing-section">
            <div style={{ maxWidth: '600px', margin: '0 auto' }} className="animate-fade-in">
              <h2 style={{ fontFamily: "'Instrument Serif', Georgia, serif", fontSize: '44px', fontWeight: 400, letterSpacing: '-0.02em', marginBottom: '16px' }}>
                Ready to build?
              </h2>
              <p style={{ fontSize: '18px', color: 'var(--text-secondary)', marginBottom: '32px' }}>
                Start turning your app idea into reality — no coding experience required.
              </p>
              <Button variant="primary" size="lg" onClick={() => setShowAuth(true)}>
                <Icons.Sparkles /> Get Started Free
              </Button>
            </div>
          </section>

          {/* Footer */}
          <footer style={{ padding: '32px 48px', borderTop: '1px solid var(--border)', textAlign: 'center' }}>
            <p style={{ fontSize: '13px', color: 'var(--text-muted)' }}>
              AI App Helper — Built with Claude AI
            </p>
          </footer>
        </div>
      );
    };

    // ============================================
    // MAIN APP
    // ============================================
    const App = () => {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [currentView, setCurrentView] = useState('dashboard');
      const [skillLevel, setSkillLevel] = useState(localStorage.getItem('ai-app-helper-skill-level') || 'intermediate');
      const [projects, setProjects] = useState([]);
      const [currentProject, setCurrentProject] = useState(null);
      const [loadingProjects, setLoadingProjects] = useState(false);
      const toast = useToast();

      // Check for existing session on load
      useEffect(() => {
        supabase.auth.getSession().then(({ data: { session } }) => {
          setUser(session?.user ?? null);
          setLoading(false);
        });
        const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
          setUser(session?.user ?? null);
        });
        return () => subscription.unsubscribe();
      }, []);

      // Load projects from Supabase when user logs in
      useEffect(() => {
        if (!user) { setProjects([]); return; }
        setLoadingProjects(true);
        supabase.from('projects').select('*').eq('user_id', user.id).order('created_at', { ascending: false })
          .then(({ data, error }) => {
            if (!error && data) setProjects(data);
            setLoadingProjects(false);
          });
      }, [user]);

      // Save skill level
      useEffect(() => { localStorage.setItem('ai-app-helper-skill-level', skillLevel); }, [skillLevel]);

      const createProject = async (name) => {
        const { data, error } = await supabase.from('projects').insert({ user_id: user.id, name, context: {} }).select().single();
        if (!error && data) {
          setProjects(prev => [data, ...prev]);
          setCurrentProject(data);
          setCurrentView('workflow');
          toast(`Project "${name}" created!`, 'success');
        } else {
          toast('Failed to create project', 'error');
        }
      };

      const updateProject = async (updated) => {
        const { error } = await supabase.from('projects').update({ context: updated.context, updated_at: new Date().toISOString() }).eq('id', updated.id);
        if (!error) {
          setProjects(prev => prev.map(p => p.id === updated.id ? updated : p));
          setCurrentProject(updated);
        }
      };

      const deleteProject = async (id) => {
        const { error } = await supabase.from('projects').delete().eq('id', id);
        if (!error) {
          setProjects(prev => prev.filter(p => p.id !== id));
          if (currentProject?.id === id) { setCurrentProject(null); setCurrentView('dashboard'); }
          toast('Project deleted', 'info');
        }
      };

      const handleLogout = async () => {
        await supabase.auth.signOut();
        setUser(null);
        setCurrentProject(null);
        setCurrentView('dashboard');
      };

      if (loading) return (
        <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', background: 'var(--bg-primary)' }}>
          <div style={{ textAlign: 'center', color: 'var(--text-muted)' }}><Icons.Loader /><p style={{ marginTop: '16px' }}>Loading...</p></div>
        </div>
      );

      if (!user) return <LandingPage onAuth={setUser} />;

      const agentMatch = currentView.match(/^agent-(.+)$/);
      const activeAgent = agentMatch ? AGENTS.find(a => a.id === agentMatch[1]) : null;

      return (
        <div style={styles.container}>
          <div style={styles.main}>
            <Sidebar currentView={currentView} setCurrentView={setCurrentView} currentProject={currentProject} user={user} onLogout={handleLogout} />
            <main style={styles.content}>
              {currentView === 'dashboard' && <Dashboard setCurrentView={setCurrentView} projects={projects} setCurrentProject={setCurrentProject} createProject={createProject} loadingProjects={loadingProjects} />}
              {currentView === 'projects' && <ProjectsView projects={projects} deleteProject={deleteProject} setCurrentProject={setCurrentProject} setCurrentView={setCurrentView} loadingProjects={loadingProjects} />}
              {currentView === 'workflow' && currentProject && <WorkflowView project={currentProject} setCurrentView={setCurrentView} updateProject={updateProject} user={user} />}
              {currentView === 'settings' && <SettingsView skillLevel={skillLevel} setSkillLevel={setSkillLevel} />}
              {activeAgent && currentProject && <AgentView agent={activeAgent} project={currentProject} updateProject={updateProject} skillLevel={skillLevel} setCurrentView={setCurrentView} user={user} />}
              {activeAgent && !currentProject && (
                <div style={{ textAlign: 'center', padding: '64px' }}>
                  <h2 style={styles.h2}>No project selected</h2>
                  <p style={{ color: 'var(--text-secondary)', marginBottom: '24px' }}>Create or select a project first.</p>
                  <Button variant="primary" onClick={() => setCurrentView('dashboard')}>Go to Dashboard</Button>
                </div>
              )}
            </main>
          </div>
        </div>
      );
    };

    ReactDOM.render(<ToastProvider><App /></ToastProvider>, document.getElementById('root'));
  </script>
</body>
</html>
